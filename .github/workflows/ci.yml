name: ImunoEdge CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  PYTHON_VERSION_DEFAULT: "3.11"

jobs:
  # ─── Lint ──────────────────────────────────────────────────
  lint:
    name: Code Quality (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/

      - name: Run ruff format check
        run: ruff format --check src/

  # ─── Type Checking ─────────────────────────────────────────
  typecheck:
    name: Type Checking (Mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install mypy

      - name: Run mypy
        run: mypy src/imunoedge/ --ignore-missing-imports
        env:
          PYTHONPATH: src:TaipanStack/src

  # ─── Security Scanning ─────────────────────────────────────
  security:
    name: Security Scanning (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit
        run: bandit -r src/imunoedge/ -ll --skip B603,B311

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: auto

  # ─── Shell Linting ─────────────────────────────────────────
  shellcheck:
    name: Shell Linting (ShellCheck)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Run ShellCheck on install.sh
        run: shellcheck install.sh

  # ─── Smoke Test ─────────────────────────────────────────────
  smoke-test:
    name: Smoke Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel
          pip install -e .

      - name: Verify core imports
        run: |
          python -c "
          from imunoedge.core.orchestrator import ProcessOrchestrator
          from imunoedge.core.health import HealthMonitor
          from imunoedge.core.telemetry import TelemetryClient
          print('✅ Core imports OK')
          "
        env:
          PYTHONPATH: src:TaipanStack/src

      - name: Verify runtime instantiation
        run: |
          python -c "
          import os
          os.environ['IMUNOEDGE_LOG_LEVEL'] = 'CRITICAL'
          from imunoedge.main import ImunoEdgeRuntime, _env, _env_float, _env_int, _env_bool, BANNER
          assert _env('X', 'fb') == 'fb'
          assert _env_float('X', 3.14) == 3.14
          assert _env_int('X', 42) == 42
          assert _env_bool('X', True) is True
          assert 'ImunoEdge' in BANNER
          r = ImunoEdgeRuntime()
          assert r._orchestrator is not None
          assert r._health_monitor is not None
          assert r._telemetry is not None
          assert r._health_monitor.on_overheat is not None
          assert r._health_monitor.on_recover is not None
          print('✅ Runtime instantiation OK')
          "
        env:
          PYTHONPATH: src:TaipanStack/src

  # ─── Linux Distro Testing ──────────────────────────────────
  test-linux-distros:
    name: Test on ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-24.04
            image: ubuntu:24.04
            pkg_manager: apt
          - distro: fedora-42
            image: fedora:42
            pkg_manager: dnf
          - distro: archlinux
            image: archlinux:latest
            pkg_manager: pacman
          - distro: alpine-3.20
            image: alpine:3.20
            pkg_manager: apk

    container:
      image: ${{ matrix.image }}

    steps:
      - name: Install dependencies (apt)
        if: matrix.pkg_manager == 'apt'
        run: |
          apt-get update
          apt-get install -y python3 python3-pip python3-venv git

      - name: Install dependencies (dnf)
        if: matrix.pkg_manager == 'dnf'
        run: dnf install -y python3 python3-pip git

      - name: Install dependencies (pacman)
        if: matrix.pkg_manager == 'pacman'
        run: pacman -Syu --noconfirm python python-pip git

      - name: Install dependencies (apk)
        if: matrix.pkg_manager == 'apk'
        run: apk add --no-cache python3 py3-pip py3-virtualenv git bash

      - name: Check out code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install project
        run: |
          python3 -m pip install --upgrade pip --break-system-packages || python3 -m pip install --upgrade pip || true
          python3 -m pip install setuptools wheel --break-system-packages || python3 -m pip install setuptools wheel || true
          python3 -m pip install -e . --break-system-packages || python3 -m pip install -e .

      - name: Run smoke test
        run: |
          PYTHONPATH=src:TaipanStack/src python3 -c "
          import os
          os.environ['IMUNOEDGE_LOG_LEVEL'] = 'CRITICAL'
          from imunoedge.core.orchestrator import ProcessOrchestrator
          from imunoedge.core.health import HealthMonitor
          from imunoedge.core.telemetry import TelemetryClient
          from imunoedge.main import ImunoEdgeRuntime
          r = ImunoEdgeRuntime()
          assert r._orchestrator is not None
          print('✅ ${{ matrix.distro }}: All subsystems OK')
          "

  # ─── Integration Gate ──────────────────────────────────────
  integration:
    name: Integration Gate
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security, shellcheck, smoke-test]
    steps:
      - name: All checks passed
        run: echo "✅ All CI checks passed — ready to merge"
